# 192.168.0.0/16 is the CIDR for Calico
- hosts: master
  become: yes
  tasks:
    - name: Initialize Kubernetes master
      command: >
        kubeadm init
        --apiserver-advertise-address={{ ansible_default_ipv4.address }}
        --pod-network-cidr=192.168.0.0/16
        --node-name master
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Prepare kubeconfig for ubuntu user
      become_user: ubuntu
      file:
        path: /home/ubuntu/.kube
        state: directory
        mode: "0755"

    - name: Copy admin.conf to kubeconfig
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        owner: ubuntu
        group: ubuntu
        mode: "0644"
        remote_src: yes

    - name: Install operator CRDs
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/operator-crds.yaml

    - name: Install Calico operator
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/tigera-operator.yaml

    - name: Install Calico custom resources
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.30.3/manifests/custom-resources.yaml

    - name: Generate kubeadm join command
      command: kubeadm token create --print-join-command
      register: kubeadm_join

    - name: Get latest etcd release tag
      uri:
        url: https://api.github.com/repos/etcd-io/etcd/releases/latest
        return_content: yes
      register: etcd_release

    - name: Set etcd version fact
      set_fact:
        etcd_version: "{{ (etcd_release.json.tag_name | regex_replace('^v', '')) }}"

    - name: Download etcd release archive
      get_url:
        url: "https://github.com/etcd-io/etcd/releases/download/v{{ etcd_version }}/etcd-v{{ etcd_version }}-linux-amd64.tar.gz"
        dest: "/tmp/etcd-v{{ etcd_version }}-linux-amd64.tar.gz"
        mode: "0644"

    - name: Extract etcd release
      unarchive:
        src: "/tmp/etcd-v{{ etcd_version }}-linux-amd64.tar.gz"
        dest: "/tmp/"
        remote_src: yes
        creates: "/tmp/etcd-v{{ etcd_version }}-linux-amd64/etcdctl"

    - name: Install etcdctl binary
      copy:
        src: "/tmp/etcd-v{{ etcd_version }}-linux-amd64/etcdctl"
        dest: "/usr/local/bin/etcdctl"
        mode: "0755"
        remote_src: yes

    - name: Install etcdutl binary
      copy:
        src: "/tmp/etcd-v{{ etcd_version }}-linux-amd64/etcdutl"
        dest: "/usr/local/bin/etcdutl"
        mode: "0755"
        remote_src: yes

- hosts: workers
  become: yes
  tasks:
    - name: Join worker nodes to the cluster
      command: "{{ hostvars[groups['master'][0]].kubeadm_join.stdout }}"
      args:
        creates: /etc/kubernetes/kubelet.conf
